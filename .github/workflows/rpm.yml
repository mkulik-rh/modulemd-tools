---
name: Create RPM

on:
  workflow_dispatch:
  workflow_call:

jobs:
  rpm:
    runs-on: ubuntu-latest
    concurrency: test-env
    environment: test-env
    env:
      ARCH: ${{ github.runner.arch }}
    container:
      image: ghcr.io/${{ github.repository_owner }}/docker-builder:latest
      credentials:
        username: $GITHUB_REPOSITORY_OWNER
        password: ${{ secrets.GHCR_PAT }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Create source RPM within mock
        run: |
          VERSION=$(sed -n 's/Version: //p' modulemd-tools.spec | head -1)
          git archive HEAD --prefix=modulemd-tools-$VERSION/ -o modulemd-tools-$VERSION.tar
          gzip modulemd-tools-$VERSION.tar
          mock -v -r fedora-35-$ARCH --buildsrpm --spec modulemd-tools.spec --sources modulemd-tools-$VERSION.tar.gz
          cp /var/lib/mock/fedora-35-$ARCH/result/modulemd-tools-$VERSION-*.src.rpm .
      - name: Clean up
        run: |
          mock --scrub all -r fedora-35-$ARCH
      - name: Rebuild RPM within mock
        run: |
          VERSION=$(sed -n 's/Version: //p' modulemd-tools.spec | head -1)
          mock -v -r fedora-35-$ARCH --postinstall rebuild modulemd-tools-$VERSION-*.src.rpm
      - name: (Post) Clean up
        run: |
          git clean -dfx
          mock --scrub all -r fedora-35-$ARCH
